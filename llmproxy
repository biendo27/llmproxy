#!/usr/bin/env bash
set -euo pipefail

resolve_path() {
  local p="$1"
  if command -v python3 >/dev/null 2>&1; then
    python3 - <<'PY' "$p"
import os, sys
print(os.path.realpath(sys.argv[1]))
PY
    return
  fi
  if command -v readlink >/dev/null 2>&1; then
    local target="$p"
    local link base
    while [ -L "$target" ]; do
      link="$(readlink "$target")" || break
      base="$(cd -- "$(dirname -- "$target")" && pwd)"
      if [[ "$link" == /* ]]; then
        target="$link"
      else
        target="$base/$link"
      fi
    done
    if [[ "$target" != /* ]]; then
      target="$(cd -- "$(dirname -- "$target")" && pwd)/$(basename "$target")"
    fi
    echo "$target"
    return
  else
    echo "$p"
  fi
}

SCRIPT_PATH="$(resolve_path "$0")"
HERE="$(cd -- "$(dirname -- "$SCRIPT_PATH")" && pwd)"

if [[ "${1:-}" == "init" ]]; then
  echo "source \"$HERE/.llmproxy.zsh\""
  exit 0
fi

if ! command -v zsh >/dev/null 2>&1; then
  echo "zsh not found. Please install zsh and try again." >&2
  exit 1
fi

quoted=""
if [[ $# -gt 0 ]]; then
  printf -v quoted '%q ' "$@"
fi
# Force-disable xtrace inside the non-interactive zsh run
exec zsh -lc "export LLMPROXY_FORCE_NO_XTRACE=1; set +x; unsetopt xtrace; source \"$HERE/.llmproxy.zsh\"; set +x; unsetopt xtrace; llmproxy ${quoted}"
